/*  
 *  Abdeselam El-Haman  et  Cédric Simar
 *  INFO-H-303 : Bases de données - Projet Horeca (partie 2)
 * 
 *  Requêtes SQL
*/

-- R1 : Tous les utilisateurs qui apprécient au moins 3 établissements que l’utilisateur "Brenda" apprécie.

SELECT C1.UID FROM Commentaire C1
WHERE COUNT ( SELECT * FROM Commentaire C2
			  WHERE C1.UID = C2.UID AND C2.Score >= 4 AND C2.Nom = ANY ( SELECT DISTINCT C3.Nom FROM Commentaire C3		-- ou IN à la place de = ANY ?
												                         WHERE C3.Score >= 4 AND C3.UID = "Breda" ))
			>= 3
			
-- R2 : Tous les établissements qu’apprécie au moins un utilisateur qui apprécie tous les établissements que "Brenda" apprécie.

-- R3 : Tous les établissements pour lesquels il y a au plus un commentaire.

SELECT C.Nom FROM Commentaire C
GROUP BY C.Nom
HAVING COUNT(*) < 2

-- R4 : La liste des administrateurs n’ayant pas commenté tous les établissements qu’ils ont crées.

SELECT E.Createur FROM Etablissements E
GROUP BY E.Createur
HAVING COUNT (DISTINCT E.Nom) <> COUNT(SELECT DISTINCT C.Nom FROM Commentaire C   -- distinct car si plusieurs commentaires pour le même établissement
									   WHERE C.UID = E.Createur)		

-- R5 : La liste des établissements ayant au minimum trois commentaires, classée selon la moyenne des scores attribués.

SELECT C.Nom, AVG(C.Score) FROM Commentaire C
GROUP BY C.Nom 
HAVING COUNT (*) >= 3
ORDER BY AVG(C.Score)

-- R6 : La liste des labels étant appliqués à au moins 5 établissements, classée selon la moyenne des scores des établissements ayant ce label.

SELECT L.Label FROM Labelise L
GROUP BY L.Label
HAVING COUNT(*) >= 5
ORDER BY ( SELECT AVG(C.Score) FROM Commentaire C
		   WHERE C.Nom = L.Nom )
		